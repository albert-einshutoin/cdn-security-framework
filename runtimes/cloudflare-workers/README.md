# Cloudflare Workers Runtime

This directory is **legacy / reference**. The **deployable code** is generated by the CLI into **`dist/edge/cloudflare/`**.

## Deploy from generated code

1. Edit **`policy/security.yml`** (or `policy/base.yml`).
2. Run **`npx cdn-security build --target cloudflare`**.
3. Deploy the generated **`dist/edge/cloudflare/index.ts`** to Cloudflare Workers (e.g. copy into your Worker project and run `wrangler deploy`).

Do **not** edit `src/index.ts` in this directory by hand for policy-driven config; the CLI reads the policy and injects config (allow methods, block rules, admin gate, response headers) into the template.

## What does it protect?

- Same “entry blocking, normalization, header injection” as CloudFront Functions.
- Workers can also hold state when combined with KV / Durable Objects (e.g., for rate limiting).

## Setup (for generated Worker)

```bash
# From your project (or examples/cloudflare/):
npm install --save-dev cdn-security-framework
npx cdn-security init --platform cloudflare --profile balanced --force
npx cdn-security build --target cloudflare
```

Then use `dist/edge/cloudflare/index.ts` in your Worker and:

```bash
wrangler secret put EDGE_ADMIN_TOKEN
wrangler deploy
```

## Verification

```bash
curl -i https://YOUR_WORKER_DOMAIN/admin
curl -i -H "x-edge-token: YOUR_TOKEN" https://YOUR_WORKER_DOMAIN/admin
```

## What else can you do?

- Per-IP rate limiting with KV / Durable Objects (hard to do with Functions alone).
- More advanced bot detection (design so it does not overlap with WAF features).
