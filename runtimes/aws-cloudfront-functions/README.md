# AWS CloudFront Functions Runtime

This directory is **legacy / reference**. The **deployable code** is generated by the CLI into **`dist/edge/`**.

## Deploy from generated code

1. Edit **`policy/security.yml`** (or `policy/base.yml`).
2. Run **`npx cdn-security build`**.
3. Deploy the files in **`dist/edge/`** (`dist/edge/viewer-request.js` and `dist/edge/viewer-response.js`) to CloudFront Functions (Terraform `file()`, CDK, or console).

Do **not** edit `viewer-request.js` in this directory by hand; it is replaced by the generated `dist/edge/viewer-request.js`. The CLI reads the policy and injects config (allow methods, block rules, admin gate, etc.) into the template.

## What does it protect?

- Reduces the attack surface at the edge (unwanted methods, path traversal, anomalous User-Agent, excessive query params)
- Query normalization (e.g., strip utm and similar to avoid cache key pollution)
- Enforces security headers at the CDN (consistent across multiple origins)

## Where to attach

- `dist/edge/viewer-request.js` → **Viewer Request**
- `dist/edge/viewer-response.js` → **Viewer Response** (generated from policy `response_headers` and `routes`)

## Admin token

Set `EDGE_ADMIN_TOKEN` in your environment or secrets; the build injects it at compile time when the variable is set. No manual replacement of `CFG.adminGate.token` in code.

## Verification (example)

```bash
curl -i https://YOUR_DOMAIN/admin
curl -i -H "x-edge-token: YOUR_TOKEN" https://YOUR_DOMAIN/admin
curl -i "https://YOUR_DOMAIN/?utm_source=x&foo=1"
```

## What else can you do?

- Create a separate Behavior for `/api/*` and extend `allow_methods` in the policy (e.g., PUT, DELETE).
- Block only obvious attacks in Functions; leave rate limiting and OWASP to AWS WAF.
