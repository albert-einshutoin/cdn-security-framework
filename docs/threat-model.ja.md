# 脅威モデル

本ドキュメントは、本 Edge セキュリティフレームワークが対象とする脅威を整理し、
Edge / WAF / Origin のどのレイヤーが担当するかを明確にします。

---

## スコープ

* **対象**: CDN エッジに到達するトラフィック（Viewer Request / Origin Request / Workers fetch）。
* **対象外**: 内部 DB 不正利用、業務ロジックの欠陥、認証後の不正（アプリケーションで対応）。

---

## 脅威カテゴリ

### 1. パストラバーサル / LFI

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| URI 内の明らかな `../`、`%2e%2e`、エンコードされたパス操作 | 早期ブロック (400) | WAF マネージドルールで広いパターン対応；Origin でパス解決を検証 |

**フレームワーク**: Edge で粗いパターン（`..\/`、`%2e%2e` 等）をブロック。網羅は WAF/Origin。

---

### 2. 不要な HTTP メソッド

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| TRACE, CONNECT、公開パスへの任意メソッド | ブロック (405) | — |

**フレームワーク**: ポリシーの `allow_methods`；リスト外は Edge で拒否。

---

### 3. スキャナ / 自動化 (UA ベース)

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| 既知スキャナ UA（sqlmap, nikto, acunetix, masscan 等） | ブロック (403) | Bot 管理、レート制限、CAPTCHA |

**フレームワーク**: Edge で UA 拒否リストによる粗い遮断。高度な Bot 検知は WAF。

---

### 4. クエリ文字列の悪用 (DoS / キャッシュ汚染)

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| 過剰なクエリ長・パラメータ数 | ブロック (414 / 400) | — |
| utm_*, gclid, fbclid によるキャッシュキー汚染 | 正規化（キー除去） | — |

**フレームワーク**: `max_query_length`、`max_query_params`、`drop_query_keys`。

---

### 5. ヘッダー欠落・不正

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| User-Agent 欠落（自動化の可能性） | ポリシーに応じてブロック (400) または許可 | — |

**フレームワーク**: 任意の `header_missing` ブロック（例: User-Agent）。プロファイルで設定可能。

---

### 6. 管理・内部パスの露出

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| /admin, /docs, /swagger への未認証アクセス | 簡易トークンゲート (401) | 機密操作はアプリで認証 |

**フレームワーク**: Edge の auth_gate（静的トークン）。強固な認証は Origin または Lambda@Edge（JWT 等）。

---

### 7. セキュリティヘッダー欠落

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| HSTS, X-Content-Type-Options, CSP 等の欠落 | レスポンスに付与 | — |

**フレームワーク**: Viewer Response / Worker がポリシーに従いヘッダーを付与。

---

### 8. 情報漏洩

| 脅威 | Edge の責務 | WAF / Origin |
|------|-------------|--------------|
| X-Powered-By、Server バージョン等のレスポンス | 除去または上書き | — |

**フレームワーク**: レスポンスハンドラで該当ヘッダーを除去・正規化可能。

---

## 本フレームワークが対象としないもの

* **高度な Bot 挙動**（WAF / Bot Management）。
* **ボディに対する OWASP Top 10**（WAF / アプリケーション）。
* **レート制限**（WAF / API ゲートウェイ）。
* **DDoS**（CDN + Shield / WAF）。
* **内部 / DB 不正**（アプリケーション）。

Edge と WAF の切り分けは `decision-matrix.ja.md` を参照してください。
