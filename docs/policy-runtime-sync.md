# Policy and Runtime Sync

This document describes how **policy** (`policy/security.yml` or `policy/base.yml`) and **runtimes** (CloudFront Functions, Lambda@Edge, Cloudflare Workers) stay in sync.

---

## Current State

* **Policy** is the single source of truth. You edit YAML to change:
  * Allowed methods, query/URI limits
  * Block rules (path patterns, UA deny list, missing headers)
  * Normalization (e.g. `drop_query_keys`)
  * Routes (e.g. `/admin`, `/docs`) and auth gate
  * Response headers (HSTS, CSP, etc.)

* **CloudFront Functions (viewer-request)** is **generated** by the CLI compiler. Run `npx cdn-security build` after editing the policy; it reads the policy, validates it, and writes **Edge Runtime** code to `dist/edge/*.js` (e.g. `dist/edge/viewer-request.js`). No manual sync of `CFG` or runtime config for this target.

* **Lambda@Edge** and **Cloudflare Workers** are not yet generated by the compiler. For those runtimes, align config and logic with the policy by hand until codegen is implemented.

---

## Workflow When You Change the Policy

1. Edit `policy/security.yml` (or `policy/base.yml`).
2. Build (validates policy and generates Edge code):
   ```bash
   npx cdn-security build
   ```
3. Deploy the generated files in **`dist/edge/`** to your CDN (e.g. Terraform `file("dist/edge/viewer-request.js")`, CDK, or console).
4. For Lambda@Edge / Cloudflare Workers (when not yet generated): update the corresponding runtime files by hand to match the policy, then deploy.

---

## Policy Compiler (Implemented)

The **policy compiler** (CLI: `npx cdn-security build`) does the following:

* Reads `policy/security.yml` or `policy/base.yml` (and optionally a path via `--policy`).
* Validates the policy (lint).
* Generates **Edge Runtime** code for the chosen target (e.g. AWS CloudFront Functions) into `dist/edge/*.js`.

The mapping from policy to generated code is implemented in `scripts/compile.js` and the templates in `templates/`.

---

## Where to See the Mapping

| Policy concept        | CloudFront Functions     | Lambda@Edge        | Cloudflare Workers   |
| --------------------- | ------------------------ | ------------------- | -------------------- |
| `request.allow_methods` | `CFG.allowMethods`       | Same pattern        | `CFG.allowMethods`   |
| `request.limits`      | `CFG.maxQueryLength` etc.| Same                | Same                 |
| `request.block.*`     | `CFG.blockPathMarks`, `CFG.uaDenyContains` | Same | Same                 |
| `request.normalize.drop_query_keys` | `CFG.dropQueryKeys` | Same                | `CFG.dropQueryKeys`  |
| `routes[].auth_gate`  | `CFG.adminGate`          | Same                | `env.EDGE_ADMIN_TOKEN` + prefixes |
| `response_headers`    | `viewer-response.js`     | Origin response     | Response header set  |

See also [Architecture](architecture.md), [Decision matrix](decision-matrix.md), and [Observability](observability.md).
