# 判断マトリクス: Edge と WAF の切り分け

ある制御を **Edge**（CloudFront Functions / Workers）に置くか **WAF**（AWS WAF / Cloudflare WAF）に置くかの判断に使います。

---

## 原則

| 基準 | Edge 向き | WAF 向き |
|------|-----------|----------|
| レイテンシ | 超低レイテンシ、外部呼び出しなし | ルール評価・状態の許容可 |
| 状態 | ステートレスに限る | ステートフル（レート、セッション、IP リスト） |
| 参照するデータ | メソッド、URI、クエリ、ヘッダーのみ | ボディ、フルリクエスト、経時挙動 |
| 複雑さ | 単純なパターンマッチ・正規化 | 複雑なルール、ML、CAPTCHA |

---

## 制御種別ごと

| 制御 | Edge | WAF | 備考 |
|------|------|-----|------|
| 不要メソッドのブロック（GET/HEAD/POST のみ許可） | ✓ | — | Edge: 高速・無状態。 |
| パストラバーサル（粗い: `../`、エンコード） | ✓ | ✓ | Edge: 第一フィルタ。WAF: 広いパターン。 |
| UA 拒否リスト（スキャナ名） | ✓ | — | Edge: 単純な文字列一致。 |
| Bot / 自動化検知（挙動） | — | ✓ | WAF: ステートフル、フィンガープリント。 |
| レート制限 | — | ✓ | WAF または API ゲートウェイ。 |
| クエリ長・パラメータ数制限 | ✓ | — | Edge: 軽い。 |
| クエリキー正規化（utm_* 等除去） | ✓ | — | Edge: キャッシュの健全性。 |
| User-Agent 欠落ブロック | ✓ | — | Edge: 1 ヘッダー検査。 |
| 静的トークンゲート（/admin） | ✓ | — | Edge: 1 ヘッダー。強固な認証は Origin/Lambda@Edge。 |
| JWT / OIDC 検証 | — | — | Lambda@Edge または Origin。CloudFront Functions では不可。 |
| セキュリティヘッダー付与 | ✓ | — | Edge: レスポンス書き換え。 |
| OWASP CRS / ボディの SQLi, XSS | — | ✓ | WAF マネージドルール。 |
| CAPTCHA / チャレンジ | — | ✓ | WAF / Bot Management。 |
| Geo / ASN ブロック | 任意（Workers） | ✓ | WAF の方が容易なことが多い。 |
| DDoS 対策 | — | ✓ | CDN + Shield / WAF。 |

---

## まとめ

* **Edge**: 正規化、粗いブロック、ヘッダー付与、簡易トークンゲート。状態なし・ボディなし・最小レイテンシ。
* **WAF**: レート制限、OWASP、Bot、CAPTCHA、ボディ検査、ステートフルルール。
* **Origin / Lambda@Edge**: 強固な認証（JWT）、業務ルール、動的設定。

迷ったら: **状態** や **ボディ** や **複雑なロジック** が必要なら Edge Functions ではなく WAF または Origin に配置する。
